<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-color Keyword Bubble Chart</title>
    <style>
        body {
            font-family: sans-serif;
        }
        svg {
            display: block;
            margin: auto;
        }
    </style>
</head>
<body>
    <h1 style="font-family: NYTFranklin, Georgia, serif; text-align: center;">Two-color Keyword Bubble Chart</h1>
    <div style="font-family: NYTFranklin, Georgia, serif; text-align: center; display: flex; justify-content: center; align-items: center; margin-top: 10px;">
        <div style="background-color: #fbcdcd; width: 30px; height: 20px; margin-right: 5px;"></div>
        <span>Approx. Asset (Millions)</span>
        <div style="background-color: #c4d7ea; width: 30px; height: 20px; margin: 0px 5px;"></div>
        <span>Approx. Deposit (Millions)</span>
      </div>
    <div style="position: relative; display: flex; align-items: center;font-family: NYTFranklin, Georgia, serif;">
        <div style="position: absolute; left: 0; top: 0;">
            <button id="sortButton">Rank as Closing Time</button>
            <button id="backButton">Rank as default</button>
          <svg id="chart" width="1200" height="800"></svg>
        </div>
        <div id="info" width="800" height="800" style="position: absolute; left: 1210px; top: 50%; transform: translateY(100%); font-size: 20px;"></div>
    </div>
      
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        function wrap(text, width) {
        text.each(function () {
            var text = d3.select(this),
                words = text.text().split(/\s+/).reverse(),
                word,
                line = [],
                lineNumber = 0,
                lineHeight = 1.1, // ems
                x = text.attr("x"),
                y = text.attr("y"),
                dy = 0, //parseFloat(text.attr("dy")),
                tspan = text.text(null)
                    .append("tspan")
                    .attr("x", x)
                    .attr("y", y)
                    .attr("dy", dy + "em");
            while (word = words.pop()) {
                line.push(word);
                tspan.text(line.join(" "));
                if (tspan.node().getComputedTextLength() > width) {
                    line.pop();
                    tspan.text(line.join(" "));
                    line = [word];
                    tspan = text.append("tspan")
                        .attr("x", x)
                        .attr("y", y)
                        .attr("dy", ++lineNumber * lineHeight + dy + "em")
                        .text(word);
                }
            }
        });
    }

        const requestData = async function() {
        const FDICdata = await d3.csv('data4.csv');
        let selectedCircle = null;
        const data1 = [];
        function parseCurrencyStringToNumber(str) {
            const cleanedString = str.replace(/[^0-9.]+/g, "");
            const number = parseFloat(cleanedString);
            return number;
        }
        FDICdata.forEach((d) => {
            const name = Number(d['ID']);
            const transaction = String(d['Acquirer & Transaction'])
            const bankName = String(d['Bank Name']);
            const location = String(d[' City, State']);
            const Release = String(d['Press Release (PR)']);
            const closeTime = String(d['Closing Date']);
            const asset = parseCurrencyStringToNumber(d['Approx. Asset (Millions)']);
            const deposit = parseCurrencyStringToNumber(d['Approx. Deposit (Millions)']);
            data1.push([name, [asset, deposit, bankName, location, closeTime, Release,transaction]]);
        });
        const data = data1.sort((a, b) => b[1][0] - a[1][0]).slice(0, 50);
let maxValue = 0;
data.forEach((d) => {
  const [asset, deposit, bankName, location, closeTime, Release, transaction] = d[1];
  maxValue = Math.max(maxValue, asset, deposit);
});

const scale = d3.scaleLinear()
  .domain([0, maxValue])
  .range([0, 100]);

function scaledValue(value) {
  return scale(value);
}

const nodes = data.map(([label, [value1, value2, name, location, closeTime, Release, transaction]]) => {
  const scaledValue1 = scaledValue(value1);
  const scaledValue2 = scaledValue(value2);
  const total = scaledValue1 + scaledValue2;
  return {
    label,
    value1,
    name,
    location,
    closeTime,
    Release,
    transaction,
    value2,
    scaledValue1,
    scaledValue2,
    radius: Math.sqrt(total / Math.PI)*20,
  };
});


const width = 1000;
const height = 800;

const svg = d3.select("#chart");
const svbIndex = nodes.findIndex(d => d.name == "Silicon Valley Bank");
function ticked() {
    bubbles.attr("transform", d => `translate(${d.x}, ${d.y})`);
    //虚线+文字修不好了！！！！！！！！！！！！！！！！1
    /* console.log([nodes[svbIndex]])
    if (svbIndex !== -1) {
        linesAndText.selectAll("line")
            .data([nodes[svbIndex]])
            .join("line")
            .attr("x1", d => d.x)
            .attr("y1", d => d.y + d.radius)
            .attr("x2", d => d.x)
            .attr("y2", d => d.y + d.radius + 50)
            .attr("stroke", "grey")
            .attr("stroke-width", 1)
            .attr("stroke-dasharray", "1,2");

        linesAndText.selectAll("text")
            .data([nodes[svbIndex]])
            .join("text")
            .attr("x", d => d.x)
            .attr("y", d => d.y + d.radius + 70)
            .attr("text-anchor", "middle")
            .attr("dominant-baseline", "middle")
            .style("fill", "grey")
            .text("The collapse of Silicon Valley Bank in March 2023 represents the largest bank failure since the financial crisis of 2008. ")
            .call(wrap, 300);
    } */
}

/* function ticked() {
    bubbles.attr("transform", d => `translate(${d.x}, ${d.y})`);
    if (svbIndex !== -1) {
        const svb = nodes[svbIndex];

        // Find a free space around the bubble for the line and text
        let angle = 0;
        let distance = svb.radius + 60;
        let foundFreeSpace = false;

        while (!foundFreeSpace && angle < 2 * Math.PI) {
            const newX = svb.x + distance * Math.cos(angle);
            const newY = svb.y + distance * Math.sin(angle);

            const hasCollision = nodes.some((node) => {
                if (node === svb) return false;
                const dx = newX - node.x;
                const dy = newY - node.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                return distance < node.radius + 30;
            });

            if (!hasCollision) {
                foundFreeSpace = true;

                // Calculate the start point on the circle's edge
                const startPointX = svb.x + (svb.radius * Math.cos(angle));
                const startPointY = svb.y + (svb.radius * Math.sin(angle));

                linesAndText.selectAll("line")
                    .data([svb])
                    .join("line")
                    .attr("x1", startPointX)
                    .attr("y1", startPointY)
                    .attr("x2", newX)
                    .attr("y2", newY)
                    .attr("stroke", "black")
                    .attr("stroke-width", 1)
                    .attr("stroke-dasharray", "1,2");

                linesAndText.selectAll("text")
                    .data([svb])
                    .join("text")
                    .attr("x", newX)
                    .attr("y", newY + 20)
                    .attr("text-anchor", "middle")
                    .attr("dominant-baseline", "middle")
                    .style("fill", "grey")
            .text("The collapse of Silicon Valley Bank in March 2023 represents the largest bank failure since the financial crisis of 2008. ")
            .call(wrap, 300);
            } else {
                angle += Math.PI / 36;
            }
        }
    }
} */
//橄榄形布局
/* function targetX(d, i) {
    const middle = data.length / 2;
    const target = (width / 2) * (1 - Math.abs(i - middle) / middle);
    return i < middle ? width / 2 - target : width / 2 + target;
}
const simulation = d3.forceSimulation(nodes)
    .force("charge", d3.forceManyBody().strength(5))
    .force("collide", d3.forceCollide().radius(d => d.radius))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("x", d3.forceX().strength(0.1).x((d, i) => targetX(d, i)))
    .force("y", d3.forceY().strength(0.1).y(height / 2))
    .on("tick", ticked); */
//非橄榄形布局
const simulation = d3.forceSimulation(nodes)
    .force("charge", d3.forceManyBody().strength(5))
    .force("collide", d3.forceCollide().radius(d => d.radius))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("x", d3.forceX().strength(0.1).x(width / 2))
  .force("y", d3.forceY().strength(0.1).y(height / 2))
    .on("tick", ticked);
const bubbles = svg.selectAll("g")
    .data(nodes)
    .join("g")
    .call(drag(simulation));
const linesAndText = svg.append("g");

const defs = svg.append("defs");

bubbles.each(function(d) {
    const patternId = `pattern-${d.label}`;
    console.log(patternId)

    const pattern = defs.append("pattern")
        .attr("id", patternId)
        .attr("patternUnits", "objectBoundingBox")
        .attr("width", 1)
        .attr("height", 1);

    const patternSvg = pattern.append("svg")
        .attr("width", d.radius * 2)
        .attr("height", d.radius * 2);

    const ratio = (d.scaledValue1/(d.scaledValue1+d.scaledValue2))
    patternSvg.append("rect")
        .attr("class", "react1")
        .attr("width", d.radius * 2 * ratio)
        .attr("height", d.radius * 2)
        .attr("fill", "#c4d7ea");

    patternSvg.append("rect")
    .attr("class", "react2")
        .attr("x", d.radius * 2 * ratio)
        .attr("width", d.radius * 2 * (1 - ratio))
        .attr("height", d.radius * 2)
        .attr("fill", "#fbcdcd");
});


bubbles.append("circle")
    .attr("r", d => d.radius)
    .attr("fill", d => `url(#pattern-${d.label})`)
    .on("mouseover", function(event, d) {
        d3.select(event.currentTarget).style("cursor", "pointer")
        d3.select(`#pattern-${d.label}`).select(".react1").attr("fill", "#a9d3fc");
        d3.select(`#pattern-${d.label}`).select(".react2").attr("fill", "#faa5a5");
    })
    .on("mouseout", function(event, d) {
        d3.select(event.currentTarget).style("cursor", "default")
        d3.select(`#pattern-${d.label}`).select(".react1").attr("fill", "#c4d7ea");
        d3.select(`#pattern-${d.label}`).select(".react2").attr("fill", "#fbcdcd");
    })
    .on("click", (event, d) => {
        if (selectedCircle !== null) {
                        selectedCircle.style("stroke-width", 0)
                                    .style("stroke", "None")
                    }
                    d3.select(event.currentTarget)
                                    .style("stroke-width", 3)
                                    .style("stroke", "black")
                    selectedCircle = d3.select(event.currentTarget);
        d3.select("#info").html(`Bank: ${d.name} 
            <br> Location: ${d.location} 
            <br> Closing Time: ${d.closeTime} 
            <br> Press Release (PR): ${d.Release}
            <br> Approx. Asset (Millions): $${d.value1}
            <br> Approx. Deposit (Millions): $${d.value2}
            <br> Acquirer & Transaction: ${d.transaction}`);
    });
// Append the labels
bubbles.append("text")
    .attr("text-anchor", "middle")
    .attr("dominant-baseline", "middle")
    .attr("font-size", d => d.radius / 5.7)
    .attr("dy", d => -d.radius / 8)
    .text(d => d.name)
    .attr("fill", "black");

// Append the values
bubbles.append("text")
    .attr("text-anchor", "middle")
    .attr("dominant-baseline", "middle")
    .attr("font-size", d => d.radius / 4)
    .attr("dy", d => d.radius / 8)
    .text(d => `${d.value1}-${d.value2}`)
    .attr("fill", "black");

    
    function drag(simulation) {
        function dragstarted(event) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            event.subject.fx = event.subject.x;
            event.subject.fy = event.subject.y;
        }
        
        function dragged(event) {
            event.subject.fx = event.x;
            event.subject.fy = event.y;
        }
        
        function dragended(event) {
            if (!event.active) simulation.alphaTarget(0);
            event.subject.fx = null;
            event.subject.fy = null;
        }
        
        return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
    }

    function zoomed(event) {
    bubbles.attr("transform", d => `translate(${event.transform.applyX(d.x)}, ${event.transform.applyY(d.y)}) scale(${event.transform.k})`);
}
function dragended(event) {
    if (!event.active) {
        simulation.alphaTarget(0);
        zoomBehavior.scaleTo(svg, 1);
        zoomBehavior.translateTo(svg, width / 2, height / 2);
    }
    event.subject.fx = null;
    event.subject.fy = null;
}

function sortByClosingTime() {
    const margin = {top: 50, left: 50, right: 50, bottom: 50};
    // 转换日期格式
    nodes.forEach(d => {
        d.date = d3.timeParse("%d-%b-%y")(d.closeTime);
        console.log(d.date)
    });

    // 按关闭时间排序
    nodes.sort((a, b) => a.date - b.date);

    // 添加 x 轴比例尺
    const xScale = d3.scaleTime()
        .domain([new Date(1999, 0, 1), new Date(2025, 0, 1)])
        .range([margin.left-10, width - margin.right]);
    // 添加时间轴
    console.log(d3.extent(nodes, d => d.date))
    const xAxis = d3.axisTop(xScale)
        .tickFormat(d3.timeFormat("%Y-%m-%d"))
        .tickSizeOuter(0)
        .tickSizeInner(-height + margin.top + margin.bottom);


    svg.append("g")
        .attr("class", "xAxis")
        .attr("transform", `translate(${margin.left}, ${margin.top - 0})`) 
        .style("stroke", "grey")
        .style("stroke-dasharray", "1,2") 
        .style("color", "grey")
        .call(xAxis);

    // 更新气泡位置
    const svbIndex = nodes.findIndex(d => d.name == "Silicon Valley Bank");
    simulation.force("x", d3.forceX().strength(0.7).x(d => xScale(d.date)))
        .alpha(2).restart()
    simulation.on("tick", ticked);
    bubbles.raise();
    
}
document.getElementById("sortButton").addEventListener("click", function() {
    sortByClosingTime();
});
function sortByDefualt() {
  simulation.force("charge", d3.forceManyBody().strength(5))
    .force("collide", d3.forceCollide().radius(d => d.radius))
    .force("center", d3.forceCenter(width / 2, height / 2))
    .force("x", d3.forceX().strength(0.1).x(width / 2))
  .force("y", d3.forceY().strength(0.1).y(height / 2)).alpha(2).restart();
    svg.selectAll(".xAxis").remove();
}
document.getElementById("backButton").addEventListener("click", function() {
    sortByDefualt();
});
        }
    requestData()
    </script>
</body>
</html>
